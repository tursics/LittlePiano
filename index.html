<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width;initial-scale=1.0;maximum-scale=1.0;user-scalable=no;" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="msapplication-tap-highlight" content="no" />
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<script type="text/javascript" charset="utf-8" src="scripts/backgroundLib.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/circleLib.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/compassLib.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/NoSleep-0.5.0.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/piano.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/soundLib.js"></script>
	<style type="text/css">
		@font-face {
			font-family:'inglobal';
			src:url('scripts/inglobal.eot');
			src:url('scripts/inglobal.eot?#iefix') format('embedded-opentype'),url('scripts/inglobal.woff2') format('woff2'),url('scripts/inglobal.woff') format('woff'),url('scripts/inglobal.ttf') format('truetype'),url('scripts/inglobal.svg#inglobal') format('svg');
			font-weight:normal;
			font-style:normal;
		}
	</style>
</head>
<body>
<script type="text/javascript">
	window.addEventListener('load', init, false);

	var background = null;
	var circle = null;
	var compass = null;
	var sound = null;
	var mainSound = null;

	function init()
	{
		var noSleep = new NoSleep();
		noSleep.enable();

		preventOverscroll();

		background = new BackgroundLib();
		circle = new CircleLib('circle');
		compass = new CompassLib();
		sound = new SoundLib();

		if( sound.isOk()) {
			circle.text( 'Little Piano', 1, function() {
				setTimeout( function() {
					loadSounds(sound);
				}, 2000);
			});
		} else {
			circle.text( 'Can\'t play music. Sorry', .8, function() {});
		}
	}

	function loadSounds(sound)
	{
		circle.textSpinner( function() {
			sound.loadAssets([
				// convert youtube to mp3: http://www.youtube-mp3.org/de
//				'assets/berlinerluft.mp3', // http://www.youtube.com/watch?v=KMU0tzLwhbE
//				'assets/9000g.wav',        // file://wxWidgets/samples/sound
//				'assets/stephan.mp3',
//				'assets/pizzzzzzzz.mp3',
				'assets/interlude.mp3',
			], function() {
				showMenuMain();
			});
		});
	}

	function showMenuMain()
	{
		var menu=new Array(
		{
			icon:'play',
			callback:function() {
				circle.show('info',false);
				circle.show('help',false);

				playMusic(sound,false);
			}
		},
		{
			icon:'headphones', // icon: old gramophone record
			callback:function() {
				circle.show('info',false);
				circle.show('help',false);

				compass.setNorth();
				playMusic(sound,true);
			}
		},
		{
			icon:'music',
			callback:function() {
				circle.show('info',false);
				circle.show('help',false);

				showMenuSoundFiles();
			}
		}
		);

		circle.show('info',true,function() {
			circle.show('info',false);
			circle.show('help',false);

			showMenuInfo();
		});
		circle.show('help',true,function() {
			circle.show('info',false);
			circle.show('help',false);

			showMenuHelp();
		});

		circle.textMenu(menu);
	}

	function showMenuSoundFiles()
	{
		circle.show('close',true,function() {
			circle.show('close',false);
			showMenuMain();
		});
		circle.text('No sound files found (to be done)',.5,function() {});
	}

	function showMenuInfo()
	{
		circle.show('close',true,function() {
			circle.show('close',false);
			showMenuMain();
		});
		circle.text('Some infos about "Little Piano"...',.5,function() {});
	}

	function showMenuHelp()
	{
		circle.show('close',true,function() {
			circle.show('close',false);
			showMenuMain();
		});
		circle.text('Rotate your device to change the speed of the music',.3,function() {});
	}

	function showMenuPlay()
	{
		var menu=new Array(
		{
			icon:'forward',
			callback:function() {
				// set music position
			}
		},
		{
			icon:'pause',
			callback:function() {
				// pause the music
			}
		},
		{
			icon:'eject',
			callback:function() {
				circle.show('volume',false);
				circle.show('light',false);

				mainSound.source.stop(0);
				showMenuMain();
			}
		}
		);

		circle.show('volume',true,showMenuVolumeUp,showMenuVolumeDown);
		circle.show('light',true,function() {
			circle.show('volume',false);
			circle.show('light',false);

			showMenuLight( false);
		});

		circle.textMenu( menu);
	}

	function showMenuScratch()
	{
		var menu=new Array(
		{
			icon:'forward',
			callback:function() {
				// set music position
			}
		},
		{
			icon:'arrow-up',
			callback:function() {
				compass.setNorth();
			}
		},
		{
			icon:'eject',
			callback:function() {
				circle.show('volume',false);
				circle.show('light',false);

				compass.resetNorth();
				mainSound.source.stop(0);
				compass.unwatch();
				showMenuMain();
			}
		}
		);

		circle.show('volume',true,showMenuVolumeUp,showMenuVolumeDown);
		circle.show('light',true,function() {
			circle.show('volume',false);
			circle.show('light',false);

			showMenuLight( true);
		});

		circle.textMenu( menu);
	}

	function showMenuVolumeUp()
	{
		var volume = sound.getVolume(mainSound);

		if( volume < .9) {
			volume += .1;
		} else {
			volume = 1;
		}
		sound.setVolume(mainSound,volume);
	}

	function showMenuVolumeDown()
	{
		var volume = sound.getVolume(mainSound);

		if( volume > .1) {
			volume -= .1;
		} else {
			volume = 0;
		}
		sound.setVolume(mainSound,volume);
	}

	function showMenuLight(scratch)
	{
		circle.show('close',true,function() {
			circle.show('close',false);

			if( scratch) {
				showMenuScratch();
			} else {
				showMenuPlay();
			}
		});
		circle.text('No Philips Hue found (to be done)',.5,function() {});
	}

	function playMusic(sound,scratch)
	{
		mainSound = sound.play(0);
		mainSound.source.loop = true;

		if(scratch) {
			if( compass.isOk()) {
				compass.watch( function( degrees) {
					circle.rotate( -degrees);
				});

				var timer = setInterval( function() {
					speedTimer()
				}, 100);

				var lastDegree = compass.gpsDegree;
				function speedTimer() {
					var diff = lastDegree - compass.gpsDegree;
					if( diff > 90) {
						diff -= 360;
					} else if( diff < -90) {
						diff += 360;
					}
					lastDegree = compass.gpsDegree;

//					circle.textNow( diff, 1);
					sound.setSpeed(mainSound, .5 + diff / 10);

				}

				showMenuScratch();
			}
		} else {
			sound.setSpeed(mainSound,1);
			showMenuPlay();
		}
	}

	function preventOverscroll()
	{
		document.body.addEventListener('touchmove', function(event){
			if(!event._isScroller) {
				event.preventDefault()
			}
		});
	}

</script>
</body>
</html>
