<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="msapplication-tap-highlight" content="no" />
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<script type="text/javascript" charset="utf-8" src="scripts/backgroundLib.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/circleLib.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/compassLib.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/NoSleep-0.5.0.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/piano.js"></script>
	<script type="text/javascript" charset="utf-8" src="scripts/soundLib.js"></script>
	<style type="text/css">
		@font-face {
			font-family:'inglobal';
			src:url('scripts/inglobal.eot');
			src:url('scripts/inglobal.eot?#iefix') format('embedded-opentype'),url('scripts/inglobal.woff2') format('woff2'),url('scripts/inglobal.woff') format('woff'),url('scripts/inglobal.ttf') format('truetype'),url('scripts/inglobal.svg#inglobal') format('svg');
			font-weight:normal;
			font-style:normal;
		}
	</style>
</head>
<body>
<div id="circle"></div>
<div id="log" style="color:white;"></div>
<script type="text/javascript">
	window.addEventListener('load', init, false);

	var background = null;
	var circle = null;
	var compass = null;
	var sound = null;

	function init()
	{
		var noSleep = new NoSleep();
		noSleep.enable();

		background = new BackgroundLib();
		circle = new CircleLib('circle');
		compass = new CompassLib();
		sound = new SoundLib();

		if( sound.isOk()) {
			circle.text( 'Little Piano', 1, function() {
				setTimeout( function() {
					loadSounds(sound);
				}, 3000);
			});
		} else {
			circle.text( 'Can\'t play music. Sorry', .8, function() {});
		}
	}

	function loadSounds(sound)
	{
		circle.textSpinner( function() {
			sound.loadAssets([
				// convert youtube to mp3: http://www.youtube-mp3.org/de
//				'assets/berlinerluft.mp3', // http://www.youtube.com/watch?v=KMU0tzLwhbE
//				'assets/9000g.wav',        // file://wxWidgets/samples/sound
//				'assets/stephan.mp3',
//				'assets/pizzzzzzzz.mp3',
				'assets/interlude.mp3',
			], function() {
				addStartButton( sound);
			});
		});
	}

	function addStartButton(sound)
	{
		circle.textIcon( 'play', function() {
			circle.click( OnStartButton);
		});
	}

	function OnStartButton()
	{
		circle.click( null);

		compass.setNorth();
		playMusic(sound);
	}

	function playMusic(sound)
	{
		var str = '';
		str += 'Volume: <input id="volume" type="range" value="100" max="100" min="0"><br>';
		str += 'Rotate your device to change the speed of the music';
		document.getElementById('log').innerHTML = str;

		var mainSound = sound.play(0);
		mainSound.source.loop = true;

		document.getElementById('volume').oninput = function() {
			sound.setVolume(mainSound, this.value / 100);
			console.log('Sound volume: ' + sound.getVolume(mainSound));
		};

		if( compass.isOk()) {
			circle.text( '0', 1, function() {
				compass.watch( function( degrees) {
					circle.rotate( -degrees);
//					circle.text( degrees + 'Â°', 1);
				});

				var timer = setInterval( function() {
					speedTimer()
				}, 100);

				var lastDegree = compass.gpsDegree;
				function speedTimer() {
					var diff = lastDegree - compass.gpsDegree;
					if( diff > 90) {
						diff -= 360;
					} else if( diff < -90) {
						diff += 360;
					}
					lastDegree = compass.gpsDegree;

					circle.textNow( diff, 1);
					sound.setSpeed(mainSound, .5 + diff / 10);
				}
			});
		}
	}

</script>
</body>
</html>
